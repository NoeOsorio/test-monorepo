FROM python:3.11-slim

WORKDIR /app

ARG PORTER_NPM_TOKEN
ARG PORTER_NPM_TASKFORCESH_TOKEN
ARG PORTER_TURBO_TOKEN
ARG PORTER_TURBO_TEAM
ARG PORTER_APP_NAME

RUN echo "PORTER_NPM_TOKEN: ${PORTER_NPM_TOKEN}"
RUN echo "PORTER_NPM_TASKFORCESH_TOKEN: ${PORTER_NPM_TASKFORCESH_TOKEN}"
RUN echo "PORTER_TURBO_TOKEN: ${PORTER_TURBO_TOKEN}"
RUN echo "PORTER_TURBO_TEAM: ${PORTER_TURBO_TEAM}"
RUN echo "PORTER_APP_NAME: ${PORTER_APP_NAME}"

ENV NPM_TOKEN=${PORTER_NPM_TOKEN}
ENV NPM_TASKFORCESH_TOKEN=${PORTER_NPM_TASKFORCESH_TOKEN}
ENV TURBO_TOKEN=${PORTER_TURBO_TOKEN}
ENV TURBO_TEAM=${PORTER_TURBO_TEAM}

RUN echo "NPM_TOKEN: ${NPM_TOKEN}"
RUN echo "NPM_TASKFORCESH_TOKEN: ${NPM_TASKFORCESH_TOKEN}"
RUN echo "TURBO_TOKEN: ${TURBO_TOKEN}"
RUN echo "TURBO_TEAM: ${TURBO_TEAM}"

COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .

RUN python3 -c "import json, os; keys = ['NPM_TOKEN', 'NPM_TASKFORCESH_TOKEN', 'TURBO_TOKEN', 'TURBO_TEAM']; status = {k: bool(os.environ.get(k)) for k in keys}; open('/app/build_args_status.json', 'w').write(json.dumps(status))"

EXPOSE 5051

CMD ["python", "app.py"]

